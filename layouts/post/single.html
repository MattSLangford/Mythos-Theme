{{ define "main" }}
<article class="post">
    <header class="post-header">
        {{ if .Title }}
        <h1 class="post-title">{{ .Title }}</h1>
        {{ end }}
        
        <div class="post-meta">
            <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                {{ .Date | time.Format ":date_long" }}
            </time>
        </div>
    </header>
    
    <div class="post-content">
        {{ .Content }}
    </div>
    
    {{ if and .Params.categories (not .Site.Params.show_categories) }}
    <div class="post-categories">
        <div class="category-list">
            {{ range .Params.categories }}
            {{ $categoryName := . }}
            {{ $categoryTaxonomy := index $.Site.Taxonomies.categories ($categoryName | urlize) }}
            <a href="/categories/{{ . | urlize }}" class="category-button">{{ . }} ({{ len $categoryTaxonomy.Pages }})</a>
            {{ end }}
        </div>
    </div>
    {{ end }}
    
    <footer class="post-footer">
        {{ if or (templates.Exists "partials/reply-by-email.html") (templates.Exists "partials/conversation-link.html") (not .Site.Params.hide_share_links) (not .Site.Params.hide_copy_links) }}
        <div class="post-actions">
            {{ if templates.Exists "partials/reply-by-email.html" }}
                {{ partial "reply-by-email.html" . }}
            {{ end }}
            {{ if templates.Exists "partials/conversation-link.html" }}
                {{ partial "conversation-link.html" . }}
            {{ end }}
            {{ if not .Site.Params.hide_share_links }}
                {{ $shareText := "" }}
                {{ if .Title }}
                    {{ $shareText = .Title }}
                {{ else }}
                    {{ $shareText = .Summary | truncate 100 }}
                {{ end }}
                <a href="https://shareopenly.org/share/?url={{ .Permalink }}&text={{ $shareText }}" 
                   class="share-link-button" target="_blank" rel="noopener noreferrer" 
                   title="{{ T "Share" }}">
                    <i class="fas fa-share-nodes" aria-hidden="true"></i>
                    {{ T "Share" }}
                </a>
            {{ end }}
            {{ if not .Site.Params.hide_copy_links }}
                <button class="copy-link-button" data-url="{{ .Permalink }}" title="{{ T "CopyLink" }}">
                    <i class="fas fa-copy" aria-hidden="true"></i>
                    {{ T "CopyLink" }}
                </button>
            {{ end }}
        </div>
        {{ end }}
        
        {{ if .Site.Params.include_conversation }}
        <script type="text/javascript" src="https://micro.blog/conversation.js?url={{ .Permalink }}"></script>
        {{ end }}
        
        {{ if not .Site.Params.hide_copy_links }}
        <script>
        (function() {
            const copyButton = document.querySelector('.copy-link-button');
            if (!copyButton) return;
            
            const url = copyButton.dataset.url;
            const copiedText = '{{ T "LinkCopied" }}';
            
            copyButton.addEventListener('click', async function() {
                try {
                    // Try modern clipboard API first
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(url);
                        showCopiedFeedback();
                    } else {
                        // Fallback for older browsers or non-HTTPS
                        const textArea = document.createElement('textarea');
                        textArea.value = url;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            showCopiedFeedback();
                        } catch (err) {
                            console.error('Failed to copy link:', err);
                        } finally {
                            textArea.remove();
                        }
                    }
                } catch (err) {
                    console.error('Failed to copy link:', err);
                }
            });
            
            function showCopiedFeedback() {
                copyButton.setAttribute('data-copied-text', copiedText);
                copyButton.classList.add('copied');
                copyButton.disabled = true;
                
                setTimeout(() => {
                    copyButton.classList.remove('copied');
                    copyButton.disabled = false;
                    copyButton.removeAttribute('data-copied-text');
                }, 2000);
            }
        })();
        </script>
        {{ end }}
    </footer>
</article>
{{ end }}